<html>
  <head>
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.2.1/pure-min.css">
    <link href='http://fonts.googleapis.com/css?family=Maven+Pro:400,500,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Give+You+Glory' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600,300' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Esteban' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Flavors' rel='stylesheet' type='text/css'>
    <link href="css/regular/style.css" rel="stylesheet" type="text/css">
    <link href="css/global.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
    
    function getLoadAndPaintShit() {
      $.ajax('/api/load', { dataType: 'json' }).done(function(response) {
        var loadTable = [];   
        loadTable[0] = ['Index', '1m', '5m', '15m'];
        if (response.l < 50) {
          for (var i = 0; i < 50 - response.l; i++) {
            loadEntry = [
              i,
              0.0,
              0.0,
              0.0
            ]
            loadTable.push(loadEntry);
          }
        }
        for (var i = 0; i < response.l; i++) {
          loadEntry = [
            i + (50 - response.l),
            response.load[i]['1min'],
            response.load[i]['5min'],
            response.load[i]['15min']
          ];

          loadTable.push(loadEntry);
        }

        var options = {
          curveType: 'function',
          fontName: 'maven pro',
          vAxis: {
            maxValue: 3.0,
            minValue: 0.0,
            gridlines: {
              count: 16,
              color: '#f6f6f6'
            }
          },
          hAxis: {
            gridlines: {
              color: '#f6f6f6'
            }
          },
          colors: ['#ff2d55', '#5ac8fa', '#4cd964']
        };
        var chartData = google.visualization.arrayToDataTable(loadTable);
        var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(chartData, options);

        if (!refresh) {
          refresh = setInterval(getLoadAndPaintShit, 2000);
        }
        
      });
    };

    function getMemInfoAndBakePie() {
      $.ajax('/api/mem_info', { dataType: 'json' }).done(function(response) {
        var memTable = [];
        memTable[0] = ['Type', 'MB'];
        if (response.mem_info[0].hasOwnProperty('cached')) {
          /* Linux. */
          memTable[1] = ['Free', response.mem_info[response.l - 1]['free']];
          memTable[2] = ['Used', response.mem_info[response.l - 1]['used']]; 
          memTable[3] = ['Cached', response.mem_info[response.l - 1]['cached']]; 
        } else {
          /* OSX */
          memTable[1] = ['Free', response.mem_info[response.l - 1]['free']];
          memTable[2] = ['Active', response.mem_info[response.l - 1]['active']]; 
          memTable[3] = ['Inactive', response.mem_info[response.l - 1]['inactive']]; 
          memTable[4] = ['Wired', response.mem_info[response.l - 1]['wired']]; 
        }
        var pieData = google.visualization.arrayToDataTable(memTable);
        var options = {
          colors: ['#ff2d55', '#5ac8fa', '#4cd964', '#ffcc00'],
          pieSliceText: 'value',
          fontName: 'maven pro'
        };
        var chart = new google.visualization.PieChart(document.getElementById('memory_pie'));
        chart.draw(pieData, options);
        
        if (!pie_refresh) {
          pie_refresh = setInterval(getMemInfoAndBakePie, 3000); 
        }

      }); 
    }

    function getMemInfoAndPaintLayers() {
      $.ajax('/api/mem_info', { dataType: 'json' }).done(function(response) {
        var memTable = [];
        if (response.mem_info[0].hasOwnProperty('cached')) {
          memTable[0] = ['Index', 'Used', 'Cached', 'Free'];
          for (var i = 0; i < response.l; i++) {
            memEntry = [
              i,
              response.mem_info[i]['used'],
              response.mem_info[i]['cached'],
              response.mem_info[i]['free']
            ];
            memTable.push(memEntry);
          }
        } else {
          memTable[0] = ['Index', 'Wired', 'Active', 'Inactive', 'Free'];
          for (var i = 0; i < response.l; i++) {
            memEntry = [
              i,
              response.mem_info[i]['wired'],
              response.mem_info[i]['active'],
              response.mem_info[i]['inactive'],
              response.mem_info[i]['free']
            ];
            memTable.push(memEntry);
          }
        }
        var areaData = new google.visualization.arrayToDataTable(memTable);
        var options = {
          colors: ['#ff2d55', '#5ac8fa', '#4cd964', '#ffcc00'],
          isStacked: true,
          areaOpacity: 0.8,
          fontName: 'maven pro',
          hAxis: {
            gridlines: {
              color: '#f6f6f6'
            }
          },
          vAxis: {
            gridlines:{color: '#f6f6f6'}}
        };
        var chart = new google.visualization.AreaChart(document.getElementById('memory_area'));
        chart.draw(areaData, options);

        if (!area_refresh) {
          area_refresh = setInterval(getMemInfoAndPaintLayers, 3000);
        }
      }); 
    }

    function drawApacheColumns() {
      $.ajax('/api/apache', { dataType: 'json'}).done(function(response) {
        var apacheTable = [];
        apacheTable[0] = ['Index', 'Requests', 'Transfer'];
        for (var i = 0; i < response.l; i++) {
          apacheEntry = [
            i,
            response.apache_activity[i]['requests'],
            response.apache_activity[i]['transfer']
          ];
          apacheTable.push(apacheEntry);
        }
        var apacheData = new google.visualization.arrayToDataTable(apacheTable);
        var options = { 
          colors: ['#ff2d55', '#5ac8fa', '#4cd964', '#ffcc00'],
          fontName: 'maven pro',
          hAxis: {
            gridlines: {
              color: '#f6f6f6'
            }
          },
          vAxis: {
            gridlines:{color: '#f6f6f6'}}
        };
        var chart = new google.visualization.ColumnChart(document.getElementById('apache_columns'));
        chart.draw(apacheData, options);

        if (!apache_refresh) {
          apache_refresh = setInterval(drawApacheColumns, 3000);
        }
      });        
    }
    
    
    function drawPostgresColumns() {
      $.ajax('/api/postgres/10', { dataType: 'json'}).done(function(response) {
        var postgresTable = [];
        postgresTable[0] = ['Index', 'Returned', 'Fetched', 'Inserts', 'Updates', 'Deletes'];
        for (var i = 0; i < response.l; i++) {
          postgresEntry = [
            i,
            response.postgres_stats[i]['returned'],
            response.postgres_stats[i]['fetched'],
            response.postgres_stats[i]['inserted'],
            response.postgres_stats[i]['updated'],
            response.postgres_stats[i]['deleted']
          ];
          postgresTable.push(postgresEntry);
        }
        var postgresData = new google.visualization.arrayToDataTable(postgresTable);
        var options = { 
          colors: ['#ff2d55', '#5ac8fa', '#4cd964', '#ffcc00'],
          fontName: 'maven pro',
          hAxis: {
            gridlines: {
              color: '#f6f6f6'
            }
          },
          vAxis: {
            gridlines:{color: '#f6f6f6'}}
        };
        var chart = new google.visualization.ColumnChart(document.getElementById('postgres_columns'));
        chart.draw(postgresData, options);

        if (!postgres_refresh) {
          postgres_refresh = setInterval(drawPostgresColumns, 3000);
        }
      });        
    }

    
    function drawMysqlColumns() {
      $.ajax('/api/mysql', { dataType: 'json'}).done(function(response) {
        var mysqlTable = [];
        mysqlTable[0] = ['Index', 'Selects', 'Inserts', 'Updates', 'Deletes', 'Connections'];
        for (var i = 0; i < response.l; i++) {
          mysqlEntry = [
            i,
            response.mysql_stats[i]['select'],
            response.mysql_stats[i]['insert'],
            response.mysql_stats[i]['update'],
            response.mysql_stats[i]['delete'],
            response.mysql_stats[i]['connections']
          ];
          mysqlTable.push(mysqlEntry);
        }
        var mysqlData = new google.visualization.arrayToDataTable(mysqlTable);
        var options = { 
          colors: ['#ff2d55', '#5ac8fa', '#4cd964', '#ffcc00'],
          fontName: 'maven pro',
          hAxis: {
            gridlines: {
              color: '#f6f6f6'
            }
          },
          vAxis: {
            gridlines:{color: '#f6f6f6'}}
        };
        var chart = new google.visualization.ColumnChart(document.getElementById('mysql_columns'));
        chart.draw(mysqlData, options);

        if (!mysql_refresh) {
          mysql_refresh = setInterval(drawMysqlColumns, 3000);
        }
      });        
    }
    
    function drawNginxColumns() {
      $.ajax('/api/nginx', { dataType: 'json'}).done(function(response) {
        var nginxTable = [];
        nginxTable[0] = ['Index', 'Requests', 'Transfer'];
        for (var i = 0; i < response.l; i++) {
          nginxEntry = [
            i,
            response.nginx_activity[i]['requests'],
            response.nginx_activity[i]['transfer']
          ];
          console.log("nginxEntry " + i + ": " + nginxEntry);
          nginxTable.push(nginxEntry);
        }
        var nginxData = new google.visualization.arrayToDataTable(nginxTable);
        var options = { 
          colors: ['#ff2d55', '#5ac8fa', '#4cd964', '#ffcc00'],
          fontName: 'maven pro',
          hAxis: {
            gridlines: {
              color: '#f6f6f6'
            }
          },
          vAxis: {
            gridlines:{color: '#f6f6f6'}}
        };
        var chart = new google.visualization.ColumnChart(document.getElementById('nginx_columns'));
        chart.draw(nginxData, options);

        if (!nginx_refresh) {
          nginx_refresh = setInterval(drawApacheColumns, 3000);
        }
      });        
    }

    google.load("visualization", "1", {packages:["corechart"]});
    google.setOnLoadCallback(getLoadAndPaintShit);
    google.setOnLoadCallback(getMemInfoAndBakePie);
    google.setOnLoadCallback(getMemInfoAndPaintLayers);
    google.setOnLoadCallback(drawApacheColumns);
    google.setOnLoadCallback(drawPostgresColumns);
    google.setOnLoadCallback(drawNginxColumns);

    var refresh = false;
    var pie_refresh = false;
    var area_refresh = false;
    var apache_refresh = false;
    var postgres_refresh = false;
    var mysql_refresh = false;
    var nginx_refresh = false;

    </script>

  </head>
  <body>

    <div class="pure-g" id="monster-bar">
      <div class="pure-u-1-4 pinkish">
        <span class="monster-name">monster</span>
          <span class="monster-text">version one, we think</span>
      </div>
      <div class="pure-u-1-4 yellowish"></div>
      <div class="pure-u-1-4 greenish"></div>
      <div class="pure-u-1-4 blueish">
        <a href="/logout" id="logout-link">logout</a>
      </div>
    </div>

    <div class="pure-g">
      <div class="pure-u-1-6 left-col"><h1 style="font-family:'esteban';text-align:center;">load</h1></div>
      <div class="pure-u-2-3 chart-col" id="chart_div"></div>
      <div class="pure-u-1-6 right-col"></div>
    </div>

    <div class="pure-g">
      <div class="pure-u-1-6 left-col"><h1 style="font-family:'esteban';text-align:center;">memory pie</h1></div>  
      <div class="pure-u-2-3 chart-col" id="memory_pie"></div>
      <div class="pure-u-1-6 right-col"></div> 
    </div>

    <div class="pure-g">
      <div class="pure-u-1-6 left-col" ><h1 style="font-family:'esteban';text-align:center;">memory usage</h1></div>  
      <div class="pure-u-2-3 chart-col" id="memory_area"></div>
      <div class="pure-u-1-6 right-col"></div> 
    </div>

    <div class="pure-g">
      <div class="pure-u-1-6" style="height:360px;"><h1 style="font-family:'esteban';text-align:center;">apache stats</h1></div>  
      <div class="pure-u-2-3" id="apache_columns" style="height:360px;"></div>
      <div class="pure-u-1-6" style="height:360px;"></div> 
    </div>

    <div class="pure-g">
      <div class="pure-u-1-6" style="height:360px;"><h1 style="font-family:'esteban';text-align:center;">postgres stats</h1></div>  
      <div class="pure-u-2-3" id="postgres_columns" style="height:360px;"></div>
      <div class="pure-u-1-6" style="height:360px;"></div> 
    </div>

    <div class="pure-g">
      <div class="pure-u-1-6" style="height:360px;"><h1 style="font-family:'esteban';text-align:center;">mysql stats</h1></div>  
      <div class="pure-u-2-3" id="mysql_columns" style="height:360px;"></div>
      <div class="pure-u-1-6" style="height:360px;"></div> 
    </div>

    <div class="pure-g">
      <div class="pure-u-1-6" style="height:360px;"><h1 style="font-family:'esteban';text-align:center;">nginx stats</h1></div>  
      <div class="pure-u-2-3" id="nginx_columns" style="height:360px;"></div>
      <div class="pure-u-1-6" style="height:360px;"></div> 
    </div>
  </body>
</html>
